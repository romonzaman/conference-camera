<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>üë• Conference Friends</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'pulse-slow': 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-blue-500 via-purple-500 to-pink-500 min-h-screen p-4">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-4">
            <h1 class="text-2xl md:text-3xl font-bold text-white mb-2">üë• Conference Friends</h1>
            <p class="text-white/80 text-sm">Active participants in the conference</p>
        </div>

        <!-- Main Content -->
        <div class="bg-white rounded-2xl shadow-2xl overflow-hidden">
            <!-- Status Bar -->
            <div class="bg-gradient-to-r from-indigo-500 to-purple-600 px-4 py-2">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <div id="statusIndicator" class="w-3 h-3 rounded-full bg-yellow-400 animate-pulse"></div>
                        <span id="statusText" class="text-white font-medium text-sm">Loading...</span>
                    </div>
                    <div class="flex items-center space-x-3 text-white/80 text-xs">
                        <span id="totalClients">0 clients</span>
                        <span id="activeSpeaker">No active speaker</span>
                        <!-- Log Level Controls -->
                        <div class="flex items-center space-x-1">
                            <span class="text-white/60 text-xs">Log:</span>
                            <button id="logDebug" onclick="setLogLevel('DEBUG')" class="px-2 py-1 text-xs bg-white/20 hover:bg-white/30 rounded transition-colors">DEBUG</button>
                            <button id="logInfo" onclick="setLogLevel('INFO')" class="px-2 py-1 text-xs bg-white/30 hover:bg-white/40 rounded transition-colors">INFO</button>
                            <button id="logNotice" onclick="setLogLevel('NOTICE')" class="px-2 py-1 text-xs bg-white/20 hover:bg-white/30 rounded transition-colors">NOTICE</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 p-3 bg-gray-50">
                <div class="bg-white rounded-lg p-2 shadow-sm border border-gray-200">
                    <div class="flex items-center">
                        <div class="p-1 bg-blue-100 rounded">
                            <span class="text-sm">üë•</span>
                        </div>
                        <div class="ml-2">
                            <p class="text-xs font-medium text-gray-600">Total</p>
                            <p id="totalClientsCount" class="text-lg font-bold text-gray-900">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg p-2 shadow-sm border border-gray-200">
                    <div class="flex items-center">
                        <div class="p-1 bg-green-100 rounded">
                            <span class="text-sm">üé§</span>
                        </div>
                        <div class="ml-2">
                            <p class="text-xs font-medium text-gray-600">Speaker</p>
                            <p id="activeSpeakerName" class="text-sm font-bold text-gray-900">None</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg p-2 shadow-sm border border-gray-200">
                    <div class="flex items-center">
                        <div class="p-1 bg-purple-100 rounded">
                            <span class="text-sm">üìπ</span>
                        </div>
                        <div class="ml-2">
                            <p class="text-xs font-medium text-gray-600">Video</p>
                            <p id="videoTracksCount" class="text-lg font-bold text-gray-900">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg p-2 shadow-sm border border-gray-200">
                    <div class="flex items-center">
                        <div class="p-1 bg-orange-100 rounded">
                            <span class="text-sm">üîä</span>
                        </div>
                        <div class="ml-2">
                            <p class="text-xs font-medium text-gray-600">Audio</p>
                            <p id="audioActiveCount" class="text-lg font-bold text-gray-900">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Friends List -->
            <div class="p-3">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-lg font-bold text-gray-800">Active Participants</h2>
                    <div class="flex items-center space-x-1">
                        <button id="refreshBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white px-2 py-1 rounded text-xs font-medium transition-colors flex items-center space-x-1">
                            <span>üîÑ</span>
                            <span>Refresh</span>
                        </button>
                        <a href="/viewer" class="bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded text-xs font-medium transition-colors flex items-center space-x-1">
                            <span>üëÅÔ∏è</span>
                            <span>Viewer</span>
                        </a>
                        <a href="/" class="bg-gray-500 hover:bg-gray-600 text-white px-2 py-1 rounded text-xs font-medium transition-colors flex items-center space-x-1">
                            <span>üè†</span>
                            <span>Home</span>
                        </a>
                    </div>
                </div>

                <!-- Friends List -->
                <div id="friendsList" class="space-y-1">
                    <div class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-2">üë•</div>
                        <p class="text-sm">No participants yet</p>
                        <p class="text-xs">Waiting for clients to connect...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let statusInterval = null;

        // DOM elements
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const totalClients = document.getElementById('totalClients');
        const activeSpeaker = document.getElementById('activeSpeaker');
        const totalClientsCount = document.getElementById('totalClientsCount');
        const activeSpeakerName = document.getElementById('activeSpeakerName');
        const videoTracksCount = document.getElementById('videoTracksCount');
        const audioActiveCount = document.getElementById('audioActiveCount');
        const friendsList = document.getElementById('friendsList');
        const refreshBtn = document.getElementById('refreshBtn');

        // Update status display
        function updateStatus(hasClients, text) {
            statusText.textContent = text;
            
            if (hasClients) {
                statusIndicator.className = 'w-4 h-4 rounded-full bg-green-400 animate-pulse';
            } else {
                statusIndicator.className = 'w-4 h-4 rounded-full bg-yellow-400 animate-pulse';
            }
        }

        // Update stats
        function updateStats(data) {
            const clientCount = data.connected_clients || 0;
            const activeSpeakerId = data.active_speaker;
            const videoTracks = data.video_tracks || 0;
            const audioLevels = data.audio_levels || {};
            const clientInfo = data.client_info || {};

            // Update counts
            totalClientsCount.textContent = clientCount;
            videoTracksCount.textContent = videoTracks;
            audioActiveCount.textContent = Object.keys(audioLevels).length;

            // Update active speaker
            if (activeSpeakerId && clientInfo[activeSpeakerId]) {
                const speakerInfo = clientInfo[activeSpeakerId];
                activeSpeakerName.textContent = speakerInfo.name || 'Unknown';
                activeSpeaker.textContent = `Speaking: ${speakerInfo.name || 'Unknown'}`;
            } else {
                activeSpeakerName.textContent = 'None';
                activeSpeaker.textContent = 'No active speaker';
            }

            // Update status
            if (clientCount > 0) {
                updateStatus(true, `${clientCount} participants connected`);
            } else {
                updateStatus(false, 'Waiting for participants to connect...');
            }
        }

        // Update friends list
        function updateFriendsList(data) {
            const clientInfo = data.client_info || {};
            const activeSpeakerId = data.active_speaker;
            const audioLevels = data.audio_levels || {};
            const mutedClients = data.muted_clients || [];
            const clients = Object.entries(clientInfo);

            if (clients.length === 0) {
                friendsList.innerHTML = `
                    <div class="col-span-full text-center py-12 text-gray-500">
                        <div class="text-6xl mb-4">üë•</div>
                        <p class="text-lg">No participants yet</p>
                        <p class="text-sm">Waiting for clients to connect...</p>
                    </div>
                `;
                return;
            }

            // Sort clients: viewers first, then participants by channel number
            const sortedClients = clients.sort(([clientIdA, infoA], [clientIdB, infoB]) => {
                const isViewerA = clientIdA.startsWith('viewer_');
                const isViewerB = clientIdB.startsWith('viewer_');
                
                // Viewers go first
                if (isViewerA && !isViewerB) return -1;
                if (!isViewerA && isViewerB) return 1;
                
                // If both are viewers, sort by client ID
                if (isViewerA && isViewerB) {
                    return clientIdA.localeCompare(clientIdB);
                }
                
                // If both are participants, sort by channel number
                const channelA = infoA.channel || 0;
                const channelB = infoB.channel || 0;
                return channelA - channelB;
            });

            friendsList.innerHTML = sortedClients.map(([clientId, info]) => {
                const isActiveSpeaker = clientId === activeSpeakerId;
                const hasAudio = clientId in audioLevels;
                const isMuted = mutedClients.includes(clientId);
                const audioLevel = audioLevels[clientId] || 0;
                const isViewer = clientId.startsWith('viewer_');

                return `
                    <div class="bg-white rounded p-2 shadow-sm border transition-all duration-200 hover:shadow-md ${isActiveSpeaker ? 'border-green-400 bg-green-50' : 'border-gray-200'}">
                        <div class="flex items-center justify-between">
                            <!-- User Info -->
                            <div class="flex items-center space-x-2 flex-1 min-w-0">
                                <div class="w-6 h-6 bg-gradient-to-r ${isViewer ? 'from-purple-500 to-pink-600' : 'from-indigo-500 to-purple-600'} rounded-full flex items-center justify-center text-white font-bold text-xs">
                                    ${(info.name || 'U').charAt(0).toUpperCase()}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center space-x-1">
                                        <h3 class="font-bold text-gray-800 truncate text-sm">${info.name || 'Unknown'}</h3>
                                        ${isViewer ? '<span class="bg-purple-100 text-purple-800 text-xs font-bold px-1 py-0.5 rounded">VIEWER</span>' : ''}
                                        ${isActiveSpeaker ? '<span class="bg-green-100 text-green-800 text-xs font-bold px-1 py-0.5 rounded">SPEAKING</span>' : ''}
                                        ${hasAudio ? '<span class="bg-blue-100 text-blue-800 text-xs font-bold px-1 py-0.5 rounded">AUDIO</span>' : ''}
                                        ${isMuted ? '<span class="bg-red-100 text-red-800 text-xs font-bold px-1 py-0.5 rounded">MUTED</span>' : ''}
                                    </div>
                                    <div class="flex items-center space-x-2 text-xs text-gray-600">
                                        <span>Ch${info.channel || 'N/A'}</span>
                                        <span class="flex items-center space-x-1">
                                            <div class="w-1.5 h-1.5 rounded-full ${isActiveSpeaker ? 'bg-green-400' : 'bg-gray-400'}"></div>
                                            <span>${isActiveSpeaker ? 'Active' : 'Connected'}</span>
                                        </span>
                                        <span class="font-mono text-xs">${clientId.substring(0, 8)}...</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Audio Level Bar -->
                            ${hasAudio ? `
                                <div class="flex items-center space-x-1 mr-2">
                                    <span class="text-xs text-gray-500 w-6">${audioLevel}</span>
                                    <div class="w-12 bg-gray-200 rounded-full h-1">
                                        <div class="bg-gradient-to-r from-green-400 to-red-500 h-1 rounded-full transition-all duration-300" 
                                             style="width: ${Math.min((audioLevel / 1000) * 100, 100)}%"></div>
                                    </div>
                                </div>
                            ` : ''}

                            <!-- Control Buttons (Only for non-viewers) -->
                            ${!isViewer ? `
                                <div class="flex items-center space-x-1">
                                    <button onclick="muteUser('${clientId}')" 
                                            class="px-2 py-1 rounded transition-colors flex items-center space-x-1 ${isMuted ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-red-100 hover:bg-red-200 text-red-700'}"
                                            title="${isMuted ? 'User is already muted' : 'Mute user'}"
                                            ${isMuted ? 'disabled' : ''}>
                                        <span class="text-xs">üîá</span>
                                        <span class="text-xs font-medium">Mute</span>
                                    </button>
                                    <button onclick="unmuteUser('${clientId}')" 
                                            class="px-2 py-1 rounded transition-colors flex items-center space-x-1 ${!isMuted ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-green-100 hover:bg-green-200 text-green-700'}"
                                            title="${!isMuted ? 'User is not muted' : 'Unmute user'}"
                                            ${!isMuted ? 'disabled' : ''}>
                                        <span class="text-xs">üîä</span>
                                        <span class="text-xs font-medium">Unmute</span>
                                    </button>
                                    <button onclick="kickUser('${clientId}')" 
                                            class="p-1 rounded bg-red-100 hover:bg-red-200 text-red-700 transition-colors"
                                            title="Kick user">
                                        <span class="text-xs">üë¢</span>
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Check server status
        async function checkStatus() {
            try {
                const response = await fetch('/status');
                const data = await response.json();
                
                console.log('Server status:', data);
                
                // Update stats
                updateStats(data);
                
                // Update friends list
                updateFriendsList(data);
                
            } catch (error) {
                console.error('Error checking status:', error);
                updateStatus(false, 'Error connecting to server');
            }
        }

        // Start status monitoring
        function startMonitoring() {
            if (statusInterval) {
                clearInterval(statusInterval);
            }
            
            // Check immediately
            checkStatus();
            
            // Then check every 2 seconds
            statusInterval = setInterval(checkStatus, 2000);
        }

        // Stop status monitoring
        function stopMonitoring() {
            if (statusInterval) {
                clearInterval(statusInterval);
                statusInterval = null;
            }
        }

        // Control functions
        async function muteUser(clientId) {
            try {
                console.log('Muting client:', clientId);
                
                const response = await fetch('/mute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ client_id: clientId })
                });
                
                if (response.ok) {
                    const result = await response.text();
                    console.log('Mute result:', result);
                    // Refresh the friends list to show updated status
                    checkStatus();
                } else {
                    const error = await response.text();
                    console.error('Mute failed:', error);
                    alert(`Error: ${error}`);
                }
            } catch (error) {
                console.error('Error muting user:', error);
                alert('Error muting user');
            }
        }

        async function unmuteUser(clientId) {
            try {
                console.log('Unmuting client:', clientId);
                
                // First, get current status to find all participants
                const statusResponse = await fetch('/status');
                if (!statusResponse.ok) {
                    throw new Error('Failed to get current status');
                }
                
                const statusData = await statusResponse.json();
                const clientInfo = statusData.client_info || {};
                const allClientIds = Object.keys(clientInfo);
                
                // Mute all other participants first (only if they're not already muted)
                const mutedClients = statusData.muted_clients || [];
                const mutePromises = allClientIds
                    .filter(id => id !== clientId && !id.startsWith('viewer_')) // Don't mute viewers
                    .filter(id => !mutedClients.includes(id)) // Only mute if not already muted
                    .map(async (id) => {
                        try {
                            const response = await fetch('/mute', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ client_id: id })
                            });
                            return response.ok;
                        } catch (error) {
                            console.error(`Error muting ${id}:`, error);
                            return false;
                        }
                    });
                
                // Wait for all mute operations to complete
                await Promise.all(mutePromises);
                console.log('Muted all other participants');
                
                // Now unmute the selected participant
                const response = await fetch('/mute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ client_id: clientId })
                });
                
                if (response.ok) {
                    const result = await response.text();
                    console.log('Unmute result:', result);
                    // Refresh the friends list to show updated status
                    checkStatus();
                } else {
                    const error = await response.text();
                    console.error('Unmute failed:', error);
                    alert(`Error: ${error}`);
                }
            } catch (error) {
                console.error('Error unmuting user:', error);
                alert('Error unmuting user');
            }
        }

        async function kickUser(clientId) {
            if (!confirm('Are you sure you want to kick this user?')) {
                return;
            }
            
            try {
                console.log('Kicking user:', clientId);
                
                const response = await fetch('/kick', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ client_id: clientId })
                });
                
                if (response.ok) {
                    const result = await response.text();
                    console.log('Kick result:', result);
                    // Refresh the friends list to show updated status
                    checkStatus();
                } else {
                    const error = await response.text();
                    console.error('Kick failed:', error);
                    alert(`Error: ${error}`);
                }
            } catch (error) {
                console.error('Error kicking user:', error);
                alert('Error kicking user');
            }
        }

        // Log level control
        async function setLogLevel(level) {
            try {
                const response = await fetch('/log-level', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ level: level })
                });
                
                if (response.ok) {
                    const result = await response.text();
                    console.log('Log level changed:', result);
                    
                    // Update button states
                    document.querySelectorAll('[id^="log"]').forEach(btn => {
                        btn.classList.remove('bg-white/30', 'bg-white/40');
                        btn.classList.add('bg-white/20');
                    });
                    
                    const activeBtn = document.getElementById(`log${level}`);
                    if (activeBtn) {
                        activeBtn.classList.remove('bg-white/20');
                        activeBtn.classList.add('bg-white/30');
                    }
                } else {
                    const error = await response.text();
                    console.error('Log level change failed:', error);
                    alert(`Error: ${error}`);
                }
            } catch (error) {
                console.error('Error changing log level:', error);
                alert('Error changing log level');
            }
        }

        // Event listeners
        refreshBtn.addEventListener('click', checkStatus);

        // Handle page visibility changes
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopMonitoring();
            } else {
                startMonitoring();
            }
        });

        // Handle page unload
        window.addEventListener('beforeunload', () => {
            stopMonitoring();
        });

        // Initialize
        console.log('Conference Friends initialized');
        updateStatus(false, 'Initializing...');
        startMonitoring();
    </script>
</body>
</html>